# LFS Build Script - Architecture & Flow Diagrams

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LFS Automated Builder                             â”‚
â”‚                        Architecture                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User / CI/CD Pipeline   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Environment Variables  â”‚
â”‚  (LFS_CONFIG_JSON, etc)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Docker Image â”‚
      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ lfs-build.sh    â”‚ â—„â”€â”€â”€ Main Orchestration Script (755 lines)
    â”‚                 â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Configuration   â”‚
    â”‚ Validation      â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Firebase Check  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Build Stages:   â”‚
    â”‚ Ch 5 â†’ Ch 6 â†’ Ch 7
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Logging         â”‚
    â”‚ (Firestore)     â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Upload to GCS   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                  â”‚
    â–¼                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Google Cloud   â”‚         â”‚  Google Cloud        â”‚
â”‚  Firestore       â”‚         â”‚  Storage (GCS)       â”‚
â”‚                  â”‚         â”‚                      â”‚
â”‚ builds/          â”‚         â”‚ lfs-builds/          â”‚
â”‚ â””{buildId}/      â”‚         â”‚ â””builds/             â”‚
â”‚   â”œâ”€status       â”‚         â”‚   â””{buildId}/        â”‚
â”‚   â”œâ”€logs/*       â”‚         â”‚     â””output.tar.gz   â”‚
â”‚   â””â”€...          â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  START: Cloud Run Job / Docker Container              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Parse Environment   â”‚
        â”‚ (LFS_CONFIG_JSON)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Validate Config     â”‚
        â”‚ Extract:            â”‚
        â”‚ - buildId           â”‚
        â”‚ - projectId         â”‚
        â”‚ - gcsBucket         â”‚
        â”‚ - lfsVersion        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Initialize          â”‚
        â”‚ - Directories       â”‚
        â”‚ - Logfiles          â”‚
        â”‚ - Environment       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Verify Firebase     â”‚
        â”‚ - Check gcloud      â”‚
        â”‚ - Check credentials â”‚
        â”‚ - Test Firestore    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update Firestore: Status=buildingâ”‚
    â”‚ Log: Build started               â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚
       â–¼               â–¼
  Chapter 5        Chapter 6        Chapter 7
  Toolchain        System           Bootloader
  
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Start Log   â”‚  â”‚ Start Log    â”‚  â”‚Start Log â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Build Steps â”‚  â”‚ Build Steps  â”‚  â”‚Configure â”‚
  â”‚ (placeh.)   â”‚  â”‚ (placeh.)    â”‚  â”‚ GRUB     â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ Success Log â”‚  â”‚ Success Log  â”‚  â”‚Success  Lâ”‚
  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                â”‚               â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Create Output Archiveâ”‚
        â”‚ lfs-build-..-.tar.gz â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Upload to GCS        â”‚
        â”‚ gs://bucket/builds/  â”‚
        â”‚   {buildId}/...      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Update Firestore: Status=completedâ”‚
    â”‚ Log: Build successful             â”‚
    â”‚ Store GCS location                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Print Build Summary              â”‚
    â”‚ - Duration                       â”‚
    â”‚ - Errors / Warnings              â”‚
    â”‚ - Output Location                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ EXIT: 0 (Success)   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Firestore Data Model

```
Firestore Database
â”‚
â”œâ”€â”€ builds (Collection)
â”‚   â”‚
â”‚   â””â”€â”€ {buildId} (Document)
â”‚       â”‚
â”‚       â”œâ”€â”€ buildId: "build-001"
â”‚       â”œâ”€â”€ projectName: "My Build"
â”‚       â”œâ”€â”€ lfsVersion: "12.0"
â”‚       â”œâ”€â”€ email: "user@example.com"
â”‚       â”œâ”€â”€ status: "building"
â”‚       â”œâ”€â”€ timestamp: 2024-11-05T12:00:00Z
â”‚       â”œâ”€â”€ createdAt: 2024-11-05T12:00:00Z
â”‚       â”œâ”€â”€ startedAt: 2024-11-05T12:01:00Z
â”‚       â”œâ”€â”€ completedAt: null
â”‚       â”œâ”€â”€ lastLog: "Chapter 5 starting"
â”‚       â”œâ”€â”€ lastLogStage: "chapter5"
â”‚       â””â”€â”€ lastLogTime: 2024-11-05T12:05:00Z
â”‚
â”‚       â””â”€â”€ logs (Subcollection)
â”‚           â”‚
â”‚           â”œâ”€â”€ {logId-1} (Document)
â”‚           â”‚   â”œâ”€â”€ timestamp: 2024-11-05T12:00:00Z
â”‚           â”‚   â”œâ”€â”€ stage: "build"
â”‚           â”‚   â”œâ”€â”€ status: "started"
â”‚           â”‚   â”œâ”€â”€ message: "Build process started"
â”‚           â”‚   â””â”€â”€ createdAt: 2024-11-05T12:00:00Z
â”‚           â”‚
â”‚           â”œâ”€â”€ {logId-2} (Document)
â”‚           â”‚   â”œâ”€â”€ timestamp: 2024-11-05T12:01:00Z
â”‚           â”‚   â”œâ”€â”€ stage: "chapter5"
â”‚           â”‚   â”œâ”€â”€ status: "started"
â”‚           â”‚   â”œâ”€â”€ message: "Starting Chapter 5: Building temporary tools"
â”‚           â”‚   â””â”€â”€ createdAt: 2024-11-05T12:01:00Z
â”‚           â”‚
â”‚           â”œâ”€â”€ {logId-3} (Document)
â”‚           â”‚   â”œâ”€â”€ timestamp: 2024-11-05T12:15:00Z
â”‚           â”‚   â”œâ”€â”€ stage: "chapter5"
â”‚           â”‚   â”œâ”€â”€ status: "completed"
â”‚           â”‚   â”œâ”€â”€ message: "Chapter 5 completed successfully"
â”‚           â”‚   â””â”€â”€ createdAt: 2024-11-05T12:15:00Z
â”‚           â”‚
â”‚           â””â”€â”€ ... (more logs)
â”‚
â”œâ”€â”€ buildLogs (Collection - Alternative logging)
â”‚   â””â”€â”€ ... (if using alternative schema)
â”‚
â””â”€â”€ ... (other collections)
```

---

## Logging Destinations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  lfs-build.sh - Logging System                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All logging functions:
  log_info()   â”€â”€â”
  log_warn()     â”œâ”€â”€â–º Console (stdout/stderr)
  log_error()    â”‚
  log_debug()  â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â–º File: logs/build-{buildId}.log
                 â”‚
                 â”œâ”€â”€â–º Firestore: builds/{buildId}/logs/{logId}
                 â”‚    (via: write_firestore_log)
                 â”‚    (or: Node.js helper)
                 â”‚
                 â””â”€â”€â–º Reference: logs/firestore-{buildId}.log
                      (local copy of Firestore writes)

Log Output Format:
  [INFO] 2024-11-05 12:00:00 - Message text
  [WARN] 2024-11-05 12:01:00 - Warning message
  [ERROR] 2024-11-05 12:02:00 - Error message
  [DEBUG] 2024-11-05 12:03:00 - Debug details

Color Coding:
  INFO  = Green âœ“
  WARN  = Yellow âš 
  ERROR = Red âœ—
  DEBUG = Cyan ğŸ”
```

---

## Build Stage Execution Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Main Build Execution Loop               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Chapter 5       â”‚
    â”‚  Toolchain       â”‚
    â”‚  (Temporary)     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Log: chapter5/started
         â”‚
         â”œâ”€â–º Step 1: Binutils
         â”œâ”€â–º Step 2: GCC (pass 1)
         â”œâ”€â–º Step 3: Linux headers
         â”œâ”€â–º Step 4: Glibc
         â””â”€â–º Step 5: GCC (pass 2)
             â”‚
             â–¼
         Log: chapter5/completed
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Chapter 6       â”‚
    â”‚  System          â”‚
    â”‚  (in Chroot)     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Log: chapter6/started
         â”‚
         â”œâ”€â–º Step 1: Create hierarchy
         â”œâ”€â–º Step 2: Core utilities
         â”œâ”€â–º Step 3: Dev tools
         â”œâ”€â–º Step 4: System utils
         â””â”€â–º Step 5: Package mgmt
             â”‚
             â–¼
         Log: chapter6/completed
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Chapter 7       â”‚
    â”‚  Bootloader      â”‚
    â”‚  & Config        â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Log: chapter7/started
         â”‚
         â”œâ”€â–º Step 1: System config
         â””â”€â–º Step 2: GRUB install
             â”‚
             â–¼
         Log: chapter7/completed
             â”‚
             â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Post-Build      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º Log: upload/started
         â”‚
         â”œâ”€â–º Create archive
         â”œâ”€â–º Upload to GCS
         â””â”€â–º Verify upload
             â”‚
             â–¼
         Log: upload/completed
```

---

## Firebase Integration Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Firebase Integration in lfs-build.sh   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

verify_firebase()
  â”‚
  â”œâ”€â–º Check gcloud CLI installed
  â”‚     gcloud --version
  â”‚
  â”œâ”€â–º Check service account credentials
  â”‚     $GOOGLE_APPLICATION_CREDENTIALS exists
  â”‚
  â””â”€â–º Verify Firestore access
        gcloud firestore databases list

write_firestore_log()
  â”‚
  â”œâ”€â–º Method 1: gcloud CLI (primary)
  â”‚   â”‚
  â”‚   â””â”€â–º gcloud firestore documents create \
  â”‚       buildLogs --data='...'
  â”‚
  â””â”€â–º Method 2: Node.js helper (fallback)
      â”‚
      â””â”€â–º node helpers/firestore-logger.js

update_build_status()
  â”‚
  â””â”€â–º gcloud firestore documents update \
      builds/{buildId} --update="status=..."

Error Handling:
  â”‚
  â”œâ”€â–º Primary method fails
  â”‚   â””â”€â–º Fallback to secondary method
  â”‚
  â””â”€â–º Both fail
      â””â”€â–º Log warning, continue anyway
```

---

## GCS Upload Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GCS Upload Process                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Output Archiveâ”‚
    â”‚                      â”‚
    â”‚ Input: $OUTPUT_DIR   â”‚
    â”‚ Output: .tar.gz      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Verify Archive               â”‚
    â”‚ - File exists                â”‚
    â”‚ - File size > 0              â”‚
    â”‚ - Readable                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Upload to GCS                â”‚
    â”‚                              â”‚
    â”‚ Destination:                 â”‚
    â”‚ gs://{bucket}/builds/        â”‚
    â”‚   {buildId}/filename.tar.gz  â”‚
    â”‚                              â”‚
    â”‚ Method: gsutil cp            â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Log Status to Firestore      â”‚
    â”‚ - Upload successful          â”‚
    â”‚ - GCS location               â”‚
    â”‚ - File size                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Return GCS URI               â”‚
    â”‚ gs://{bucket}/builds/...     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
        (End of upload process)
```

---

## Helper Scripts Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node.js Helper Scripts                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ firestore-logger.js (150+ lines)     â”‚
â”‚                                      â”‚
â”‚ CLI Interface:                       â”‚
â”‚ node firestore-logger.js \           â”‚
â”‚   <buildId> \                        â”‚
â”‚   <stage> \                          â”‚
â”‚   <status> \                         â”‚
â”‚   <message> \                        â”‚
â”‚   [projectId]                        â”‚
â”‚                                      â”‚
â”‚ Functions:                           â”‚
â”‚ - validateInputs()                   â”‚
â”‚ - initializeFirebase()               â”‚
â”‚ - writeBuildLog()                    â”‚
â”‚                                      â”‚
â”‚ Output:                              â”‚
â”‚ - [SUCCESS] Log ID: ...              â”‚
â”‚ - [ERROR] Error message              â”‚
â”‚ - Exit: 0 (success) / 1 (failure)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ gcs-uploader.js (180+ lines)         â”‚
â”‚                                      â”‚
â”‚ CLI Interface:                       â”‚
â”‚ node gcs-uploader.js \               â”‚
â”‚   <localPath> \                      â”‚
â”‚   <bucketName> \                     â”‚
â”‚   <remotePath> \                     â”‚
â”‚   [projectId]                        â”‚
â”‚                                      â”‚
â”‚ Functions:                           â”‚
â”‚ - validateInputs()                   â”‚
â”‚ - uploadToGCS()                      â”‚
â”‚ - Progress tracking                  â”‚
â”‚                                      â”‚
â”‚ Output:                              â”‚
â”‚ - Progress: XX%                      â”‚
â”‚ - [SUCCESS] GCS location             â”‚
â”‚ - JSON: {bucket, file, uri, size}    â”‚
â”‚ - Exit: 0 (success) / 1 (failure)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Called from: lfs-build.sh
  â”‚
  â”œâ”€â–º write_firestore_log_via_helper()
  â”‚   â””â”€â–º node helpers/firestore-logger.js
  â”‚
  â””â”€â–º (Optional) upload_to_gcs_via_node()
      â””â”€â–º node helpers/gcs-uploader.js
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Error Handling in lfs-build.shâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Bash Error Trap  â”‚
    â”‚                  â”‚
    â”‚ set -euo pipefailâ”‚
    â”‚ trap 'error_...' â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â–º Command fails
            â”‚   â””â”€â–º Trap catches error
            â”‚       â”‚
            â”‚       â–¼
            â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   â”‚ error_handler()  â”‚
            â”‚   â”‚                  â”‚
            â”‚   â”œâ”€â–º Log error      â”‚
            â”‚   â”œâ”€â–º Update status  â”‚
            â”‚   â”‚   to "error"     â”‚
            â”‚   â”œâ”€â–º Write to FS    â”‚
            â”‚   â”œâ”€â–º Print summary  â”‚
            â”‚   â””â”€â–º Exit 1         â”‚
            â”‚       (FAILURE)      â”‚
            â”‚
            â””â”€â–º Function returns 1
                â””â”€â–º Calling code checks:
                    if ! function; then
                      exit 1
                    fi

Fallback Mechanisms:
  â”‚
  â”œâ”€â–º Firestore logging fails (gcloud)
  â”‚   â””â”€â–º Fallback: Node.js helper
  â”‚       â””â”€â–º Fallback: Local log file
  â”‚
  â””â”€â–º GCS upload fails
      â””â”€â–º Warn but continue
          (Build succeeded, upload failed)
```

---

## Docker Container Build

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dockerfile Build Stages        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stage 1: Builder      â”‚
    â”‚                       â”‚
    â”‚ Base: debian:bookworm â”‚
    â”‚ Install: build tools  â”‚
    â”‚ (gcc, make, etc)      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Stage 2: Runtime      â”‚
    â”‚                       â”‚
    â”‚ Base: debian:bookworm â”‚
    â”‚ Install: runtime toolsâ”‚
    â”‚ Create: lfs user      â”‚
    â”‚ Install: Node.js      â”‚
    â”‚ Install: Google CLI   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Copy: lfs-build.sh    â”‚
    â”‚ Copy: helpers/*       â”‚
    â”‚ Install: npm deps     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Setup: Directories    â”‚
    â”‚ Setup: Permissions    â”‚
    â”‚ Setup: Entrypoint     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Image Ready           â”‚
    â”‚ Entrypoint: ./lfs-... â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Environment Variable Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Environment Variables Flow      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Set by Caller              â”‚
    â”‚                            â”‚
    â”‚ Required:                  â”‚
    â”‚ - LFS_CONFIG_JSON          â”‚
    â”‚                            â”‚
    â”‚ Optional:                  â”‚
    â”‚ - GOOGLE_APPLICATION_...   â”‚
    â”‚ - PROJECT_ID               â”‚
    â”‚ - GCS_BUCKET_NAME          â”‚
    â”‚ - DEBUG                    â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Parse by lfs-build.sh      â”‚
    â”‚                            â”‚
    â”‚ Extract from JSON:         â”‚
    â”‚ - BUILD_ID                 â”‚
    â”‚ - LFS_VERSION              â”‚
    â”‚ - PROJECT_ID (if not set)  â”‚
    â”‚ - GCS_BUCKET_NAME (if...)  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Pass to Helper Scripts     â”‚
    â”‚                            â”‚
    â”‚ Firestore Logger:          â”‚
    â”‚ - PROJECT_ID               â”‚
    â”‚ - BUILD_ID                 â”‚
    â”‚ - GOOGLE_APPLICATION_...   â”‚
    â”‚                            â”‚
    â”‚ GCS Uploader:              â”‚
    â”‚ - PROJECT_ID               â”‚
    â”‚ - GCS_BUCKET_NAME          â”‚
    â”‚ - GOOGLE_APPLICATION_...   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Used Throughout Build      â”‚
    â”‚                            â”‚
    â”‚ Build Control:             â”‚
    â”‚ - MAKEFLAGS                â”‚
    â”‚ - CFLAGS / CXXFLAGS        â”‚
    â”‚ - Timeout settings         â”‚
    â”‚                            â”‚
    â”‚ Logging:                   â”‚
    â”‚ - LOG_DIR                  â”‚
    â”‚ - OUTPUT_DIR               â”‚
    â”‚ - DEBUG                    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Cloud Run Job Integration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cloud Run Job Setup & Execution    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Create Job           â”‚
    â”‚                      â”‚
    â”‚ gcloud run jobs      â”‚
    â”‚  create lfs-builder  â”‚
    â”‚  --image=...         â”‚
    â”‚  --tasks=1           â”‚
    â”‚  --timeout=3600      â”‚
    â”‚  --memory=8Gi        â”‚
    â”‚  --cpu=4             â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Execute Job                  â”‚
    â”‚                              â”‚
    â”‚ gcloud run jobs execute      â”‚
    â”‚  --set-env-vars              â”‚
    â”‚  LFS_CONFIG_JSON='...'       â”‚
    â”‚  --no-wait                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Container Starts             â”‚
    â”‚                              â”‚
    â”‚ 1. Pulls image               â”‚
    â”‚ 2. Sets environment vars     â”‚
    â”‚ 3. Runs entrypoint:          â”‚
    â”‚    /app/lfs-build.sh         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Build Executes               â”‚
    â”‚                              â”‚
    â”‚ 1. Parse config              â”‚
    â”‚ 2. Verify Firebase           â”‚
    â”‚ 3. Run stages                â”‚
    â”‚ 4. Upload results            â”‚
    â”‚ 5. Exit: 0 or 1              â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Container Cleanup            â”‚
    â”‚                              â”‚
    â”‚ Cloud Run stores:            â”‚
    â”‚ - stdout/stderr â†’ logs       â”‚
    â”‚ - exit code                  â”‚
    â”‚ - execution duration         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Monitor Progress             â”‚
    â”‚                              â”‚
    â”‚ gcloud run jobs logs read    â”‚
    â”‚ gcloud run jobs describe     â”‚
    â”‚                              â”‚
    â”‚ Or via Firestore:            â”‚
    â”‚ Watch: builds/{buildId}      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary: All Systems Connected

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  User / CI/CD    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Configuration   â”‚
                    â”‚  (JSON env var)  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
         â”‚  lfs-build  â”‚            â”‚  Dockerfileâ”‚
         â”‚  .sh        â”‚            â”‚            â”‚
         â”‚ (755 lines) â”‚            â”‚  (Updated) â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚         â”‚            â”‚          â”‚
 â”Œâ”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”
 â”‚Parseâ”‚ â”‚Verifyâ”‚ â”‚Execute â”‚ â”‚  Logging â”‚ â”‚GCSâ”‚
 â”‚JSON â”‚ â”‚Cloud â”‚ â”‚Chaptersâ”‚ â”‚Firestore â”‚ â”‚Up â”‚
 â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜
                          â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚           â”‚           â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”
         â”‚Firestoreâ”‚  â”‚Storage â”‚  â”‚Logs â”‚
         â”‚Database â”‚  â”‚Bucket  â”‚  â”‚File â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
```

---

## Key Integration Points

1. **Configuration**: JSON from environment
2. **Authentication**: Service account credentials
3. **Execution**: Docker container
4. **Logging**: Console + File + Firestore
5. **Storage**: GCS bucket
6. **Monitoring**: Firestore document updates
7. **Scripting**: Bash + Node.js helpers
8. **Cloud**: Cloud Run Jobs

---

For more details, see the comprehensive documentation in `docs/LFS_BUILD_SCRIPT.md`
