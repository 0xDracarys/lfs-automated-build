#!/bin/bash

################################################################################
# LFS Build Configuration Template
# 
# Copy this file and customize for your specific build requirements
# Source this file to set environment variables for lfs-build.sh
#
# Usage:
#   source lfs-build.config
#   ./lfs-build.sh
################################################################################

# ============================================================================
# Build Configuration (JSON format)
# ============================================================================
# This is the main configuration that lfs-build.sh reads
# All required fields must be present

export LFS_CONFIG_JSON='{
  "buildId": "build-'$(date +%s)'",
  "lfsVersion": "12.0",
  "projectId": "YOUR_GCP_PROJECT_ID",
  "gcsBucket": "lfs-builds",
  "projectName": "LFS Build '$(date +%Y-%m-%d)'",
  "email": "your-email@example.com",
  "buildOptions": {
    "includeGlibcDev": true,
    "includeKernel": true,
    "optimizeSize": false
  }
}'

# ============================================================================
# Firebase & GCP Configuration
# ============================================================================

# Path to Google Cloud service account JSON file
# Download from: GCP Console > Service Accounts > Create/Select > Keys
# Store securely and reference here
export GOOGLE_APPLICATION_CREDENTIALS="${GOOGLE_APPLICATION_CREDENTIALS:-/path/to/service-account.json}"

# Your Google Cloud Project ID
export PROJECT_ID="YOUR_GCP_PROJECT_ID"

# Google Cloud Storage bucket for build outputs
export GCS_BUCKET_NAME="lfs-builds"

# Optional: Specific Firestore database ID (default: "(default)")
# export FIRESTORE_DATABASE="(default)"

# ============================================================================
# Build Parameters
# ============================================================================

# LFS Version to build
export LFS_VERSION="12.0"

# Compiler parallelization
# -j4 = 4 parallel jobs, adjust based on available CPU cores
export MAKEFLAGS="-j4"

# Compiler optimization flags
export CFLAGS="-O2"
export CXXFLAGS="-O2"

# Build timeout settings (in seconds)
export BUILD_TIMEOUT="3600"          # Total build: 1 hour
export CHAPTER5_TIMEOUT="1800"       # Toolchain: 30 minutes
export CHAPTER6_TIMEOUT="1800"       # System: 30 minutes

# ============================================================================
# Directory Paths
# ============================================================================

# Main output directory for logs and artifacts
export LOG_DIR="${PROJECT_ROOT:-$(pwd)}/logs"
export OUTPUT_DIR="${PROJECT_ROOT:-$(pwd)}/output"

# LFS build directories
export LFS_SRC="${PROJECT_ROOT:-$(pwd)}/sources"     # Source packages
export LFS_MNT="${PROJECT_ROOT:-$(pwd)}/lfs"        # Root filesystem

# ============================================================================
# Logging & Debug
# ============================================================================

# Enable debug logging (1 = yes, 0 = no)
export DEBUG="0"

# Optional: Log level (INFO, WARN, ERROR, DEBUG)
# export LOG_LEVEL="INFO"

# Optional: Send logs to syslog
# export LOG_TO_SYSLOG="0"

# ============================================================================
# GCS Upload Configuration
# ============================================================================

# Enable/disable GCS upload (1 = yes, 0 = no)
export ENABLE_GCS_UPLOAD="1"

# GCS timeout in seconds
export GCS_TIMEOUT="300"

# Optional: Custom GCS destination path
# By default: gs://{bucket}/builds/{buildId}/
# export GCS_CUSTOM_PATH=""

# ============================================================================
# Firestore Logging
# ============================================================================

# Enable Firestore logging (1 = yes, 0 = no)
export ENABLE_FIRESTORE_LOGGING="1"

# Firestore log level (all, warnings_only, errors_only)
export FIRESTORE_LOG_LEVEL="all"

# ============================================================================
# Email Notifications
# ============================================================================

# Enable email notifications (1 = yes, 0 = no)
export ENABLE_EMAIL_NOTIFICATIONS="0"

# Email configuration (if enabled)
# export SMTP_SERVER="smtp.example.com"
# export SMTP_PORT="587"
# export SMTP_FROM="lfs-builder@example.com"
# export SMTP_TO="user@example.com"
# export SMTP_USERNAME="your-username"
# export SMTP_PASSWORD="your-password"

# ============================================================================
# Performance Tuning
# ============================================================================

# Memory settings
# export MAX_MEMORY="8G"

# CPU settings
# export MAX_CPUS="4"

# Swap settings
# export USE_SWAP="0"

# ============================================================================
# LFS Version Specific Settings
# ============================================================================

case "$LFS_VERSION" in
    12.0)
        export GLIBC_VERSION="2.38"
        export GCC_VERSION="13.2.0"
        export BINUTILS_VERSION="2.41"
        ;;
    11.3)
        export GLIBC_VERSION="2.37"
        export GCC_VERSION="12.2.0"
        export BINUTILS_VERSION="2.39"
        ;;
    11.2)
        export GLIBC_VERSION="2.36"
        export GCC_VERSION="12.1.0"
        export BINUTILS_VERSION="2.38"
        ;;
    *)
        export GLIBC_VERSION="2.38"
        export GCC_VERSION="13.2.0"
        export BINUTILS_VERSION="2.41"
        ;;
esac

# ============================================================================
# Advanced Configuration
# ============================================================================

# Strip binaries during build (reduces size, may break debugging)
# export STRIP_BINARIES="1"

# Enable link-time optimization
# export ENABLE_LTO="0"

# Build system to use (GNU Make or Ninja)
# export BUILD_SYSTEM="make"

# Parallel jobs based on CPU count
# Uncomment to auto-detect:
# export MAKEFLAGS="-j$(nproc)"

# ============================================================================
# Validation
# ============================================================================

# Check required variables
validate_config() {
    local errors=0
    
    if [ -z "$PROJECT_ID" ]; then
        echo "ERROR: PROJECT_ID not set" >&2
        errors=$((errors + 1))
    fi
    
    if [ -z "$GCS_BUCKET_NAME" ]; then
        echo "ERROR: GCS_BUCKET_NAME not set" >&2
        errors=$((errors + 1))
    fi
    
    if [ ! -f "$GOOGLE_APPLICATION_CREDENTIALS" ]; then
        echo "WARN: GOOGLE_APPLICATION_CREDENTIALS file not found: $GOOGLE_APPLICATION_CREDENTIALS" >&2
    fi
    
    if [ $errors -gt 0 ]; then
        echo "ERROR: Configuration has errors" >&2
        return 1
    fi
    
    return 0
}

# Print configuration summary
show_config() {
    echo "=========================================="
    echo "LFS Build Configuration"
    echo "=========================================="
    echo "Build ID:           $(echo "$LFS_CONFIG_JSON" | jq -r '.buildId')"
    echo "LFS Version:        $LFS_VERSION"
    echo "Project ID:         $PROJECT_ID"
    echo "GCS Bucket:         $GCS_BUCKET_NAME"
    echo "Build Timeout:      $BUILD_TIMEOUT s"
    echo "MAKEFLAGS:          $MAKEFLAGS"
    echo "Debug Mode:         $DEBUG"
    echo "Log Dir:            $LOG_DIR"
    echo "Output Dir:         $OUTPUT_DIR"
    echo "=========================================="
}

# Auto-validate on source
if [ "${VALIDATE_ON_SOURCE:-1}" == "1" ]; then
    if ! validate_config; then
        echo "Configuration validation failed!" >&2
        echo "Please update this file with correct values" >&2
    fi
fi

# Show configuration if called directly
if [ "$0" == "${BASH_SOURCE[0]}" ]; then
    show_config
fi
